{% extends "base.html" %}

{% block title %}Relatórios de Vendas - ODÚ TECH{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Menu Lateral -->
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="ODÚ TECH Logo" class="sidebar-logo">
            <h3>ODÚ TECH</h3>
        </div>

        <div class="sidebar-menu">
            <h6 class="sidebar-title">Cadastros</h6>
            <a href="{{ url_for('novo_cliente') }}" class="sidebar-link">
                <i class="bi bi-person-plus"></i>
                <span>Cadastrar Clientes</span>
            </a>
            <a href="{{ url_for('novo_produto') }}" class="sidebar-link">
                <i class="bi bi-box-seam"></i>
                <span>Registrar Produtos</span>
            </a>
            <a href="{{ url_for('novo_atendimento') }}" class="sidebar-link">
                <i class="bi bi-calendar-check"></i>
                <span>Registrar Atendimento</span>
            </a>

            <h6 class="sidebar-title">Visualizações</h6>
            <a href="{{ url_for('atendimentos') }}" class="sidebar-link">
                <i class="bi bi-cash-coin"></i>
                <span>Ver Todas as Vendas</span>
            </a>
            <a href="{{ url_for('produtos') }}" class="sidebar-link">
                <i class="bi bi-boxes"></i>
                <span>Ver Todos os Produtos</span>
            </a>
            <a href="{{ url_for('clientes') }}" class="sidebar-link">
                <i class="bi bi-people"></i>
                <span>Ver Todos os Clientes</span>
            </a>
            <a href="{{ url_for('perfil', id_usuario=current_user.id) }}" class="sidebar-link">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
            <a href="{{ url_for('relatorios_vendas') }}" class="sidebar-link active">
                <i class="bi bi-graph-up"></i>
                <span>Relatórios</span>
            </a>
        </div>

        <div class="sidebar-footer">
            <a href="{{ url_for('logout') }}" class="sidebar-link">
                <i class="bi bi-box-arrow-right"></i>
                <span>Sair</span>
            </a>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div class="dashboard-content">
        <h2><i class="bi bi-graph-up"></i> Relatórios de Vendas</h2>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filtros</h5>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="data_inicio" class="form-label">Data Início</label>
                        <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
                    </div>
                    <div class="col-md-3">
                        <label for="data_fim" class="form-label">Data Fim</label>
                        <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
                    </div>
                    <div class="col-md-3">
                        <label for="tipo" class="form-label">Tipo de Atendimento</label>
                        <select name="tipo" class="form-select">
                            <option value="">Todos os tipos</option>
                            <option value="ebó" {% if tipo == 'ebó' %}selected{% endif %}>Ebó</option>
                            <option value="gbory" {% if tipo == 'gbory' %}selected{% endif %}>Gbory</option>
                            <option value="obrigacao" {% if tipo == 'obrigacao' %}selected{% endif %}>Obrigação</option>
                            <option value="consulta" {% if tipo == 'consulta' %}selected{% endif %}>Consulta</option>
                            <option value="outro" {% if tipo == 'outro' %}selected{% endif %}>Outro</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-filter"></i> Aplicar Filtros
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Estatísticas Gerais -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total de Vendas</h5>
                        <h3>{{ total_atendimentos }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Valor Total</h5>
                        <h3>R$ {{ "%.2f"|format(total_vendas) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Ticket Médio</h5>
                        <h3>R$ {{ "%.2f"|format(total_vendas / total_atendimentos if total_atendimentos > 0 else 0) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <h5 class="card-title">Vendas/Dia</h5>
                        <h3>{{ "%.1f"|format(total_atendimentos / 30 if total_atendimentos > 0 else 0) }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estatísticas por Tipo -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Estatísticas por Tipo de Atendimento</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Quantidade</th>
                                        <th>Percentual</th>
                                        <th>Valor Total</th>
                                        <th>Ticket Médio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tipo, stats in estatisticas.items() %}
                                    <tr>
                                        <td>
                                            <span class="badge
                                                {% if tipo == 'ebó' %}bg-primary
                                                {% elif tipo == 'gbory' %}bg-success
                                                {% elif tipo == 'obrigacao' %}bg-warning
                                                {% else %}bg-info{% endif %}">
                                                {{ tipo|title }}
                                            </span>
                                        </td>
                                        <td>{{ stats.quantidade }}</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar
                                                    {% if tipo == 'ebó' %}bg-primary
                                                    {% elif tipo == 'gbory' %}bg-success
                                                    {% elif tipo == 'obrigacao' %}bg-warning
                                                    {% else %}bg-info{% endif %}"
                                                    style="width: {{ (stats.quantidade / total_atendimentos * 100) if total_atendimentos > 0 else 0 }}%">
                                                    {{ "%.1f"|format((stats.quantidade / total_atendimentos * 100) if total_atendimentos > 0 else 0) }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>R$ {{ "%.2f"|format(stats.valor_total) }}</td>
                                        <td>R$ {{ "%.2f"|format(stats.valor_total / stats.quantidade if stats.quantidade > 0 else 0) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Vendas -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">Detalhes das Vendas</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Procedimentos</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Pagamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venda in vendas %}
                            <tr>
                                <td>{{ venda.data_atendimento.strftime('%d/%m/%Y') }}</td>
                                <td>{{ venda.cliente.nome_completo }}</td>
                                <td>{{ venda.procedimentos|truncate(30) }}</td>
                                <td>
                                    <span class="badge
                                        {% if venda.tipo_atendimento == 'ebó' %}bg-primary
                                        {% elif venda.tipo_atendimento == 'gbory' %}bg-success
                                        {% elif venda.tipo_atendimento == 'obrigacao' %}bg-warning
                                        {% else %}bg-info{% endif %}">
                                        {{ venda.tipo_atendimento|title }}
                                    </span>
                                </td>
                                <td>R$ {{ "%.2f"|format(venda.valor_total) }}</td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ venda.forma_pagamento|title if venda.forma_pagamento else 'Não informado' }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">Nenhuma venda encontrada para os filtros aplicados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>/* ===========================================================
   AJUSTE DE PALETA — CLARO (AZUL / BRANCO / CINZA)
   =========================================================== */

:root {
  --light-bg: #ffffff;
  --surface: #f3f4f6;
  --border: #e5e7eb;
  --text: #111827;
  --text-muted: #6b7280;
  --primary: #2563eb;
  --primary-light: #60a5fa;
  --primary-2: #3b82f6;
}

/* ===== BADGES ===== */
.badge {
  font-size: 0.85em;
  padding: 0.45em 0.75em;
  border-radius: 8px;
  font-weight: 600;
}

.badge.bg-primary {
  background: var(--primary);
  color: #fff;
}
.badge.bg-success {
  background: #16a34a;
  color: #fff;
}
.badge.bg-warning {
  background: #facc15;
  color: #111827;
}
.badge.bg-danger {
  background: #dc2626;
  color: #fff;
}

/* ===== SIDEBAR ACTIVE ===== */
.sidebar-link.active {
  background: rgba(37, 99, 235, 0.1);
  color: var(--primary);
  font-weight: 600;
  border-left: 4px solid var(--primary);
}

/* ===== TABLE ===== */
.table th {
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
  color: #ffffff;
  border: none;
  font-weight: 600;
  padding: 15px;
}
.table td {
  padding: 12px;
  border-color: var(--border);
  color: var(--text);
  vertical-align: middle;
  background: var(--light-bg);
}
.table tbody tr:hover td {
  background: #eff6ff; /* leve azul ao passar o mouse */
}

/* ===== PROGRESS BAR ===== */
.progress {
  background: #e5e7eb;
  border-radius: 10px;
  height: 10px;
  overflow: hidden;
}
.progress-bar {
  border-radius: 10px;
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
}

/* ===== CARD TEXT CENTER ===== */
.card.text-center {
  border: 1px solid var(--border);
  border-radius: 15px;
  background: var(--light-bg);
  box-shadow: 0 6px 18px rgba(17, 24, 39, 0.06);
  color: var(--text);
}

</style>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}